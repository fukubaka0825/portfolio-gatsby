{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/manage_eks_aws_auth_config_map_with_terraform/","result":{"data":{"site":{"siteMetadata":{"title":"Takashi Narikawa - @fukubaka0825","user":{"name":"Takashi Narikawa","github":"fukubaka0825","qiita":"fukubaka0825","twitter":"fukubaka0825","facebook":"fukubaka0825","linkedin":"takashi-narikawa-889a51187"}}},"markdownRemark":{"html":"<h2>Introduction</h2>\n<p>Hi, everyone.\nI would like to leave a memorandum about how to manage Kubernetes's configmap AWS auto-generated with terraform.</p>\n<h2>What Trouble</h2>\n<ul>\n<li>If we want to add iam user/role for eks cluster operation, we need to fix auto-generated aws-auth configmap(namespace:kube-system)</li>\n<li>If we follow the official manual: <a href=\"https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html\">https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html</a>), we should manage it with kubernetes manifest yml, but we want to manage it with terraform.\n<ul>\n<li>Because at first we can access our eks cluster only with IAM user/role used when creating cluster(with ~/.kube/config as below) and our cluster generated role is terraform user/role</li>\n<li>Therefore, We want to add user/role to aws-auth configmap with terraform user/role and manage aws-auth configmap with terraform.</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token comment\"># ~/.kube/config</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>eks<span class=\"token punctuation\">:</span>ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span>1<span class=\"token punctuation\">:</span>9999999999<span class=\"token punctuation\">:</span>cluster/eks<span class=\"token punctuation\">-</span>example\n  <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">exec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> client.authentication.k8s.io/v1alpha1\n      <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>region\n      <span class=\"token punctuation\">-</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n      <span class=\"token punctuation\">-</span> eks\n      <span class=\"token punctuation\">-</span> get<span class=\"token punctuation\">-</span>token\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>cluster<span class=\"token punctuation\">-</span>name\n      <span class=\"token punctuation\">-</span> eks<span class=\"token punctuation\">-</span>example\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> aws\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n      <span class=\"token key atrule\">provideClusterInfo</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>How to resolve the trouble</h2>\n<h3>1. Add terraform aws-auth configmap resouece and Use <code class=\"language-text\">terraform import</code> command</h3>\n<h4>1.0 Prepare terraform kubernetes provider</h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl-terraform\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl-terraform line-numbers\"><code class=\"language-hcl-terraform\">provider &quot;kubernetes&quot; {\n  host                   = data.aws_eks_cluster.eks.endpoint\n  cluster_ca_certificate = base64decode(data.aws_eks_cluster.eks.certificate_authority[0].data)\n  token                  = data.aws_eks_cluster_auth.eks.token\n} \n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<ul>\n<li>Caution: we should set host/token/cluster_ca_certificate to operate kubernetes cluster with tf-provider.\n<ul>\n<li>REF: <a href=\"https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest\">https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest</a></li>\n</ul>\n</li>\n</ul>\n<h4>1.1 Prapare aws-auth configmap tf resource for importing</h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl-terraform\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl-terraform line-numbers\"><code class=\"language-hcl-terraform\"># aws-auth.tf\nresource &quot;kubernetes_config_map&quot; &quot;aws-auth&quot; {\n  data = {\n    &quot;mapRoles&quot; = &quot;&quot;\n  }\n\n  metadata {\n    name      = &quot;&quot;\n    namespace = &quot;&quot;\n  }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4>1.2 Execute <code class=\"language-text\">terraoform import</code> cmd</h4>\n<div class=\"gatsby-highlight\" data-language=\"shellscript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-shellscript line-numbers\"><code class=\"language-shellscript\">terraform import kubernetes_config_map.aws-auth kube-system/aws-auth</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<h4>1.3 terraform plan and remove diff from real resource state to resource config</h4>\n<div class=\"gatsby-highlight\" data-language=\"hcl-terraform\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl-terraform line-numbers\"><code class=\"language-hcl-terraform\">resource &quot;kubernetes_config_map&quot; &quot;aws-auth&quot; {\n  data = {\n    &quot;mapRoles&quot; = &lt;&lt;EOT\n- rolearn: arn:aws:iam::99999999999:role/hoge-role\n  username: system:node:{{EC2PrivateDNSName}}\n  groups:\n    - system:bootstrappers\n    - system:nodes\n      # Therefore, before you specify rolearn, remove the path. For example, change arn:aws:iam::&lt;123456789012&gt;:role/&lt;team&gt;/&lt;developers&gt;/&lt;eks-admin&gt; to arn:aws:iam::&lt;123456789012&gt;:role/&lt;eks-admin&gt;. FYI:https://docs.aws.amazon.com/eks/latest/userguide/troubleshooting_iam.html#security-iam-troubleshoot-ConfigMap\nEOT\n  }\n\n  metadata {\n    name      = &quot;aws-auth&quot;\n    namespace = &quot;kube-system&quot;\n  }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>2. Fix aws-auth configmap resource we imported and add iam user/role</h3>\n<div class=\"gatsby-highlight\" data-language=\"hcl-terraform\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-hcl-terraform line-numbers\"><code class=\"language-hcl-terraform\">resource &quot;kubernetes_config_map&quot; &quot;aws-auth&quot; {\n  data = {\n    &quot;mapRoles&quot; = &lt;&lt;EOT\n- rolearn: arn:aws:iam::99999999999:role/hoge-role\n  username: system:node:{{EC2PrivateDNSName}}\n  groups:\n    - system:bootstrappers\n    - system:nodes\n      # Therefore, before you specify rolearn, remove the path. For example, change arn:aws:iam::&lt;123456789012&gt;:role/&lt;team&gt;/&lt;developers&gt;/&lt;eks-admin&gt; to arn:aws:iam::&lt;123456789012&gt;:role/&lt;eks-admin&gt;. FYI:https://docs.aws.amazon.com/eks/latest/userguide/troubleshooting_iam.html#security-iam-troubleshoot-ConfigMap\n# Add as below \n- rolearn: hoge\n  username: hoge\n  groups: # REF: https://kubernetes.io/ja/docs/reference/access-authn-authz/rbac/\n    - hoge\nEOT\n  }\n\n  metadata {\n    name      = &quot;aws-auth&quot;\n    namespace = &quot;kube-system&quot;\n  }\n}</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html\">https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html</a></li>\n<li><a href=\"https://kubernetes.io/ja/docs/reference/access-authn-authz/rbac/\">https://kubernetes.io/ja/docs/reference/access-authn-authz/rbac/</a></li>\n<li><a href=\"https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest\">https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest</a></li>\n</ul>","frontmatter":{"title":"Manage EKS aws-auth configmap with terraform","date":"12 October, 2021","tags":["Kubernetes","Terraform"]}}},"pageContext":{"slug":"/manage_eks_aws_auth_config_map_with_terraform/"}},"staticQueryHashes":["2390163343"],"slicesMap":{}}